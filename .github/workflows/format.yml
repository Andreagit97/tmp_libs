name: Format code
on:
  pull_request_target:
jobs:
  clang-format:
    name: clang-format 🐲
    runs-on: ubuntu-22.04
    steps:
      - name: Install dependencies ⛓️
        run: sudo apt install -y make git

      - name: Install LLVM and Clang 📥
        uses: KyleMayes/install-llvm-action@v1.5.3
        with:
          version: "14.0.0"
          directory: ${{ runner.temp }}/llvm

      - name: Checkout repository 🎉
        uses: actions/checkout@v3

      - name: Check linting with clang-format 🔍
        run: make check-clang

      - name: Apply clang-format 🤕
        if: failure()
        run: make format-clang

      - name: Generate the git-diff 🚒
        if: failure()
        run: git diff > clang_format_diff.patch

      - name: Upload the git diff artifact 📦
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: clang_format_diff.patch
          path: ./clang_format_diff.patch

      - name: Render markdown template 📰
        if: failure()
        id: template
        uses: chuhlomin/render-template@v1.4
        with:
          template: .github/LINT_TEMPLATE.md
          vars: |
            tool: clang-format
            url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            file: clang_format_diff.patch

      - name: Issue a new comment with the link to the clang-format.patch 💬
        if: failure()
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.template.outputs.result }}
          reactions: eyes

  cmake-format:
    name: cmake-format 🥶
    runs-on: ubuntu-22.04
    steps:
      - name: Install dependencies ⛓️
        run: sudo apt install -y make git pip

      - name: Install cmake-format 📥
        run: pip install "cmakelang[YAML]==0.6.13"

      - name: Checkout repository 🎉
        uses: actions/checkout@v3

      - name: Check linting with cmake-format 🔍
        run: make check-cmake

      - name: Apply cmake-format 🤕
        if: failure()
        run: make format-cmake

      - name: Generate a git-diff 🚒
        if: failure()
        run: git diff > cmake_format_diff.patch

      - name: Upload the git diff artifact 📦
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: cmake_format_diff.patch
          path: ./cmake_format_diff.patch

      - name: Render markdown template 📰
        if: failure()
        id: template
        uses: chuhlomin/render-template@v1.4
        with:
          template: .github/LINT_TEMPLATE.md
          vars: |
            tool: cmake-format
            url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            file: cmake_format_diff.patch

      - name: Issue a new comment with the link to the cmake-format.patch 💬
        if: failure()
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.template.outputs.result }}
          reactions: confused
